{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load customfilters %}
{% load tz %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/library.css' %}">
{% endblock %}

{% block navbar %}
<li class="nav-item">
  <a class="nav-link" href="{% url "addStory" %}" >{% trans "Add story" %}</a>
</li>
{% endblock %}

{% block body %}

<div class="row">
  <div class="dropdown col-12">
    <a class="btn btn-secondary dropdown-toggle" href="#" role="button"  data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      {% trans "Sort by" %}
    </a>
    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
      <a class="dropdown-item {% ifequal sortChoice 'score'%} active {% endifequal %}" href="?sort=score&age={{ageChoice}}&language={{languageChoice}}">{% trans "Score" %}</a>
      <a class="dropdown-item {% ifequal sortChoice 'age'%} active {% endifequal %}" href="?sort=age&age={{ageChoice}}&language={{languageChoice}}">{% trans "Age category" %}</a>
      <a class="dropdown-item {% ifequal sortChoice 'pub_date'%} active {% endifequal %}" href="?sort=pub_date&age={{ageChoice}}&language={{languageChoice}}">{% trans "Most recent" %}</a>
      <a class="dropdown-item {% ifequal sortChoice 'title'%} active {% endifequal %}" href="?sort=title&age={{ageChoice}}&language={{languageChoice}}">{% trans "Title" %}</a>
      <a class="dropdown-item {% ifequal sortChoice 'uploader'%} active {% endifequal %}" href="?sort=uploader&age={{ageChoice}}&language={{languageChoice}}">{% trans "Author" %}</a>
    </div>
    <a class="btn btn-secondary dropdown-toggle" href="#" role="button"  data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      {% trans "Language" %}
    </a>
    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
      {% for language in languageDict %}
      <a class="dropdown-item {% ifequal language langChoice %} active {% endifequal %}" href="?sort={{sortChoice}}&age={{ageChoice}}&language={{language}}"> {{ languageDict|get_item:language }}</a>
      {% endfor %}
      <a class="dropdown-item {% ifequal langChoice '' %} active {% endifequal %}" href="?sort={{sortChoice}}&age={{ageChoice}}"> {% trans "All" %}</a>
    </div>
    <a class="btn btn-secondary dropdown-toggle" href="#" role="button"  data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      {% trans "Age" %}
    </a>
    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
      {% for age in ageDict %}
      <a class="dropdown-item {% ifequal age ageChoice %} active {% endifequal %}" href="?sort={{sortChoice}}&age={{age}}&language={{langChoice}}"> {{ ageDict|get_item:age }}</a>
      {% endfor %}
      <a class="dropdown-item {% ifequal ageChoice '' %} active {% endifequal %}" href="?sort={{sortChoice}}&language={{langChoice}}"> {% trans "All" %}</a>
    </div>
  </div>
</div>
{% if stories_list %}
{% for story in stories_list %}
{% if story.uploadReady %}
<div class="row story-line no-gutters">
  <div class="col-2">
    <img src="{{ story.poster.url }}" alt="{{ story.title }}" class = "poster img-fluid" />
  </div>
  <div class="col-10">
    <div class="content container-fluid">
      <div class="row">
	<div class="col-sm-12 col-12">  <a class="story-title" href={% url "watchStory" storyId=story.id %}>{{ story.title }}</a> </div>
	<div class="col-sm-12 col-12">  {{ story.abstract }}  </div>
	<div class="col-sm-3 col-6">  {{ ageDict|get_item:story.age }} </div>
	<div class="col-sm-3 col-6">  {{ languageDict|get_item:story.language }} </div>
	<div class="col-sm-3 col-6">  {% localtime off %}{{ story.pub_date.date }}{% endlocaltime %} </div>
	<div class="col-sm-3 col-6">  
	  <button class="vote {% if user in story.downvotes.all  %}selected{% endif %}" id="downvoteStory{{story.id}}" data-vote="down" data-storyid="{{story.id}}" type="button"
		  {% if not user.is_authenticated %}
		  disabled
		  {% endif %}
		  ><span>-</span></button><!--
	  --><b id="scoreStory{{ story.id }}">{{ story.score }}</b><!--
	  --><button class="vote  {% if user in story.upvotes.all  %}selected{% endif %}" id="upvoteStory{{story.id}}" data-vote="up" data-storyid="{{story.id}}" type="button"
		  {% if not user.is_authenticated %}
		  disabled
		  {% endif %}
		  ><span>+</span></button>
	</div>
	<div class="col-sm-12 col-12"> {% trans "by" %} {% if story.uploader %} {{ story.uploader.username }} {% else %} {% trans "a deleted user" %} {% endif %} <a href={{ story.storyFile.url }}>download</a>
	  <button class="toUserLib" id="toUserLib{{story.id}}" data-storyid="{{story.id}}" type="button"
		  {% if not user.is_authenticated %}
		  disabled
		  {% endif %}
		  {% if user in story.inUserLibrary.all  %}
		  style="background-color:green"
		  {% else %}
		  style="background-color:red"
		  {% endif %}
		  >UserLibrary</button>
	</div>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endfor %}
{% else %}
<p>{% trans "No story is available that matches your criteria" %}</p>
{% endif %}
<div class="pagination row">
  <div class="col-4 pageChoice" style="text-align:left;">
      {% if stories_list.has_previous %}
      <a href="?page=1"><!--
	--><svg  xmlns="http://www.w3.org/2000/svg" version="1.0" viewBox="0 0 230 240" xmlns="http://www.w3.org/2000/svg" version="1.0" width="230" height="240">
	  <path d="M 120 240 a 1 1 0 0 1 0 -240" />
	  <path d="M 230 240 a 1 1 0 0 1 0 -240" />
	</svg><!--
      --></a>
      <a href="?page={{ stories_list.previous_page_number }}"><!--
	--><svg xmlns="http://www.w3.org/2000/svg" version="1.0" viewBox="0 0 120 240" xmlns="http://www.w3.org/2000/svg" version="1.0" width="120" height="240">
	  <path d="M 120 240 a 1 1 0 0 1 0 -240" />
	</svg><!--
      --></a>
      {% endif %}
  </div>
  <div class="col-4" style="text-align:center;">
    {{ stories_list.number }} / {{ stories_list.paginator.num_pages }}
  </div>
  <div class="col-4 pageChoice" style="text-align:right;">
      {% if stories_list.has_next %}
      <a  href="?page={{ stories_list.next_page_number }}"><!--
	--><svg  xmlns="http://www.w3.org/2000/svg" version="1.0" viewBox="0 0 120 240" xmlns="http://www.w3.org/2000/svg" version="1.0" width="120" height="240">
	  <path d="M 0 240 a 1 1 0 0 0 0 -240" />
	</svg><!--
      --></a>
      <a  href="?page={{ stories_list.paginator.num_pages }}"><!--
	--><svg  xmlns="http://www.w3.org/2000/svg" version="1.0" viewBox="0 0 230 240" xmlns="http://www.w3.org/2000/svg" version="1.0" width="230" height="240">
	  <path d="M 0 240 a 1 1 0 0 0 0 -240" />
	  <path d="M 110 240 a 1 1 0 0 0 0 -240" />
	</svg><!--
      --></a>
      {% endif %}
  </div>
</div>
{% endblock %}


{% block javascript %}
<script src="{% static '/js/library_vote.js' %}"></script>
<script src="{% static '/js/library_userLib.js' %}"></script>
{% endblock javascript %}
  
  
